<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>EscazÃº Seguro</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#00e5a0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EscazÃºSeguro">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script>
const SUPABASE_URL = 'https://jhdhxedbjrtymczgtwrb.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoZGh4ZWRianJ0eW1jemd0d3JiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5ODgzOTYsImV4cCI6MjA4NzU2NDM5Nn0.6VrF8GLZLyvgwfsUdrsBKMT2jHXareFE2oq7whde85k';
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
--bg:#0a0e14;--bg2:#111720;--bg3:#1a2233;--card:#141c28;
--border:#1e2d45;--accent:#00e5a0;--accent2:#ff5252;
--accent3:#ffa726;--accent4:#448aff;
--text:#e8edf5;--text2:#8a99b3;--text3:#4a5a75;
--glow:rgba(0,229,160,0.15);
--nav-h:60px;--bottom-h:68px;--radius:16px;--radius-sm:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;max-width:430px;margin:0 auto;overflow-x:hidden;position:relative;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 40% at 80% 10%,rgba(0,229,160,.05) 0%,transparent 60%),radial-gradient(ellipse 50% 30% at 20% 80%,rgba(68,138,255,.04) 0%,transparent 60%);}
.screen{display:none;flex-direction:column;min-height:100vh;position:relative;z-index:1;}
.screen.active{display:flex;}
.top-nav{position:sticky;top:0;height:var(--nav-h);background:rgba(10,14,20,.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:100;flex-shrink:0;}
.nav-logo{display:flex;align-items:center;gap:10px;cursor:pointer;}
.nav-logo-icon{width:34px;height:34px;background:linear-gradient(135deg,var(--accent),#00b37a);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 0 14px var(--glow);}
.nav-logo-text{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;}
.nav-logo-text span{color:var(--accent);}
.nav-badge{background:var(--accent2);color:#fff;font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;font-family:'Syne',sans-serif;animation:pulse-b 2s infinite;}
@keyframes pulse-b{0%,100%{opacity:1}50%{opacity:.7}}
.bottom-nav{position:sticky;bottom:0;height:var(--bottom-h);background:rgba(10,14,20,.97);backdrop-filter:blur(24px);border-top:1px solid var(--border);display:flex;align-items:center;z-index:100;flex-shrink:0;}
.nav-items{display:flex;width:100%;padding:0 6px;}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:10px 4px;color:var(--text3);font-size:10px;font-weight:500;cursor:pointer;transition:color .2s;position:relative;border:none;background:none;}
.nav-item.active{color:var(--accent);}
.nav-item.active::after{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:22px;height:2px;background:var(--accent);border-radius:2px;}
.nav-icon{font-size:21px;transition:transform .2s;}
.nav-item.active .nav-icon{transform:translateY(-1px);}
.nav-item.rep-btn{flex:none;width:58px;}
.rep-circle{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#00b37a);display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 18px var(--glow);transition:transform .2s;}
.nav-item.rep-btn:active .rep-circle{transform:scale(.92);}
.page{flex:1;overflow-y:auto;padding:16px;}
.page::-webkit-scrollbar{width:3px;}
.page::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.section-title{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;margin:18px 0 9px;}
.page-title{font-family:'Syne',sans-serif;font-size:23px;font-weight:800;letter-spacing:-.5px;}
.page-sub{font-size:13px;color:var(--text2);margin-top:3px;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:11px;}
.hero{background:linear-gradient(135deg,rgba(0,229,160,.08),rgba(68,138,255,.05));border:1px solid rgba(0,229,160,.15);border-radius:var(--radius);padding:22px 18px;margin-bottom:11px;position:relative;overflow:hidden;}
.hero::before{content:'';position:absolute;top:-40px;right:-40px;width:140px;height:140px;background:radial-gradient(circle,rgba(0,229,160,.1),transparent 70%);}
.hero-greeting{font-size:11px;color:var(--accent);font-weight:600;letter-spacing:1px;text-transform:uppercase;font-family:'Syne',sans-serif;margin-bottom:5px;}
.hero-title{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;line-height:1.2;margin-bottom:12px;letter-spacing:-.5px;}
.hero-title em{color:var(--accent);font-style:normal;}
.hero-status{display:flex;align-items:center;gap:9px;}
.pulse{width:9px;height:9px;border-radius:50%;background:var(--accent);animation:ping 1.5s infinite;}
@keyframes ping{0%{box-shadow:0 0 0 0 rgba(0,229,160,.4)}70%{box-shadow:0 0 0 9px rgba(0,229,160,0)}100%{box-shadow:0 0 0 0 rgba(0,229,160,0)}}
.ticker-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:11px 15px;display:flex;align-items:center;gap:9px;overflow:hidden;margin-bottom:11px;}
.ticker-badge{background:var(--accent2);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;font-family:'Syne',sans-serif;flex-shrink:0;}
.ticker-scroll{font-size:11px;color:var(--text2);white-space:nowrap;animation:ticker 22s linear infinite;}
@keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-50%)}}
.quick-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:11px;}
.quick-btn{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:13px 6px;display:flex;flex-direction:column;align-items:center;gap:5px;cursor:pointer;color:var(--text2);transition:border-color .2s,background .2s;font-size:9px;font-weight:500;text-align:center;}
.quick-btn:active{background:var(--bg3);border-color:var(--accent);}
.quick-icon{font-size:23px;}
.score-ring-wrap{display:flex;align-items:center;justify-content:center;margin:14px 0;}
.score-ring{position:relative;width:120px;height:120px;}
.score-ring svg{transform:rotate(-90deg);}
.score-ring-val{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.score-num{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;color:var(--accent);line-height:1;}
.score-unit{font-size:11px;color:var(--text2);}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 14px;}
.stat-val{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;line-height:1;margin-bottom:3px;}
.stat-label{font-size:11px;color:var(--text2);}
.pill{display:inline-flex;align-items:center;gap:5px;font-size:10px;font-weight:500;padding:3px 9px;border-radius:20px;}
.pill::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.pill-green{background:rgba(0,229,160,.12);color:var(--accent);}
.pill-red{background:rgba(255,82,82,.12);color:var(--accent2);}
.pill-yellow{background:rgba(255,167,38,.12);color:var(--accent3);}
.pill-blue{background:rgba(68,138,255,.12);color:var(--accent4);}
.priority{font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;font-family:'Syne',sans-serif;text-transform:uppercase;letter-spacing:.5px;}
.p-high{background:rgba(255,82,82,.15);color:var(--accent2);}
.p-med{background:rgba(255,167,38,.15);color:var(--accent3);}
.p-low{background:rgba(68,138,255,.15);color:var(--accent4);}
.alert-item{display:flex;align-items:flex-start;gap:11px;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:9px;cursor:pointer;transition:border-color .2s;}
.alert-item:active{border-color:var(--accent);}
.alert-icon{width:42px;height:42px;flex-shrink:0;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;}
.ai-sec{background:rgba(255,82,82,.12);}
.ai-inf{background:rgba(255,167,38,.12);}
.ai-env{background:rgba(0,229,160,.12);}
.ai-tra{background:rgba(68,138,255,.12);}
.alert-body{flex:1;min-width:0;}
.alert-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.alert-meta{font-size:11px;color:var(--text2);display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.alert-desc{font-size:11px;color:var(--text2);margin-top:3px;line-height:1.4;}
.alert-votes{display:flex;flex-direction:column;align-items:center;gap:1px;flex-shrink:0;}
.vote-btn{background:none;border:none;cursor:pointer;color:var(--text3);font-size:15px;padding:3px;transition:color .2s,transform .15s;}
.vote-btn:active{transform:scale(1.4);}
.vote-btn.voted{color:var(--accent);}
.vote-count{font-size:12px;font-weight:600;font-family:'Syne',sans-serif;}
.filter-row{display:flex;gap:7px;overflow-x:auto;padding-bottom:3px;margin-bottom:14px;scrollbar-width:none;}
.filter-row::-webkit-scrollbar{display:none;}
.filter-tab{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:7px 14px;color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:'Syne',sans-serif;transition:all .2s;flex-shrink:0;}
.filter-tab.on{background:var(--accent);color:#001a0f;border-color:var(--accent);}
.input-group{margin-bottom:13px;}
.input-label{font-size:10px;font-weight:600;color:var(--text2);letter-spacing:.8px;text-transform:uppercase;display:block;margin-bottom:5px;font-family:'Syne',sans-serif;}
.input,select.input,textarea.input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 15px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;}
.input:focus,select.input:focus,textarea.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,229,160,.1);}
textarea.input{resize:none;min-height:85px;}
select.input{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a99b3' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:38px;cursor:pointer;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:13px 22px;border:none;border-radius:var(--radius-sm);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;width:100%;letter-spacing:.2px;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#00b37a);color:#001a0f;box-shadow:0 4px 18px var(--glow);}
.btn-primary:active{transform:scale(.97);}
.btn-ghost{background:var(--bg3);color:var(--text);border:1px solid var(--border);}
.btn-2col{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:13px;}
.cat-btn{background:var(--bg3);border:2px solid var(--border);border-radius:var(--radius-sm);padding:13px 10px;display:flex;align-items:center;gap:9px;cursor:pointer;color:var(--text);transition:all .2s;font-size:13px;font-family:'DM Sans',sans-serif;font-weight:500;}
.cat-btn.sel{border-color:var(--accent);background:rgba(0,229,160,.06);color:var(--accent);}
.cat-icon{font-size:21px;}
.prio-row{display:flex;gap:7px;margin-bottom:13px;}
.prio-btn{flex:1;padding:9px 4px;border-radius:var(--radius-sm);border:2px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer;text-align:center;font-size:11px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.5px;transition:all .2s;}
.prio-btn.ph{border-color:var(--accent2);background:rgba(255,82,82,.08);color:var(--accent2);}
.prio-btn.pm{border-color:var(--accent3);background:rgba(255,167,38,.08);color:var(--accent3);}
.prio-btn.pl{border-color:var(--accent4);background:rgba(68,138,255,.08);color:var(--accent4);}
.steps{display:flex;align-items:center;gap:5px;margin-bottom:18px;}
.step{width:27px;height:27px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:'Syne',sans-serif;border:2px solid var(--border);color:var(--text3);transition:all .3s;}
.step.act{border-color:var(--accent);background:var(--accent);color:#001a0f;}
.step.done{border-color:var(--accent);color:var(--accent);}
.step-line{flex:1;height:2px;background:var(--border);border-radius:1px;transition:background .3s;}
.step-line.done{background:var(--accent);}
.loc-btn{width:100%;padding:13px;background:var(--bg3);border:1px dashed var(--border);border-radius:var(--radius-sm);color:var(--text2);cursor:pointer;display:flex;align-items:center;gap:10px;font-size:13px;transition:border-color .2s;margin-bottom:9px;font-family:'DM Sans',sans-serif;}
.loc-btn.located{border-color:var(--accent);color:var(--accent);background:rgba(0,229,160,.04);}
.form-s{display:none;}
.form-s.act{display:block;animation:fi .3s ease;}
.upload-zone{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:22px;text-align:center;cursor:pointer;transition:border-color .2s;margin-bottom:13px;}
.upload-zone:active{border-color:var(--accent);}
.success-view{display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:40px 20px;flex:1;}
.success-view.show{display:flex;}
.success-icon{width:85px;height:85px;background:linear-gradient(135deg,var(--accent),#00b37a);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:38px;margin-bottom:22px;box-shadow:0 0 40px var(--glow);animation:pop .5s cubic-bezier(.34,1.56,.64,1);}
@keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
.ticket-no{font-family:'Syne',sans-serif;font-size:12px;color:var(--accent);letter-spacing:2px;background:rgba(0,229,160,.08);padding:7px 18px;border-radius:20px;margin-bottom:28px;border:1px solid rgba(0,229,160,.15);}
.sheet-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .3s;}
.sheet-overlay.open{opacity:1;pointer-events:all;}
.sheet{background:var(--card);border:1px solid var(--border);border-radius:18px 18px 0 0;padding:22px;width:100%;transform:translateY(100%);transition:transform .4s cubic-bezier(.34,1.1,.64,1);max-height:80vh;overflow-y:auto;}
.sheet-overlay.open .sheet{transform:translateY(0);}
.sheet-handle{width:34px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 18px;}
.toast{position:fixed;top:calc(var(--nav-h) + 10px);left:50%;transform:translateX(-50%) translateY(-90px);background:var(--accent);color:#001a0f;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;padding:11px 20px;border-radius:50px;box-shadow:0 8px 30px rgba(0,229,160,.3);transition:transform .4s cubic-bezier(.34,1.56,.64,1);z-index:300;white-space:nowrap;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast-err{background:var(--accent2);box-shadow:0 8px 30px rgba(255,82,82,.3);}
.skeleton{background:linear-gradient(90deg,var(--bg3) 25%,var(--border) 50%,var(--bg3) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:8px;}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.sk-item{height:80px;border-radius:var(--radius);margin-bottom:9px;}
.db-status{font-size:10px;padding:4px 10px;border-radius:20px;font-family:'Syne',sans-serif;font-weight:600;}
.db-ok{background:rgba(0,229,160,.12);color:var(--accent);}
.db-err{background:rgba(255,82,82,.12);color:var(--accent2);}
.config-warn{background:rgba(255,167,38,.08);border:1px solid rgba(255,167,38,.25);border-radius:var(--radius-sm);padding:14px;margin-bottom:14px;font-size:12px;color:var(--accent3);line-height:1.6;display:none;}
.config-warn.show{display:block;}
@keyframes fi{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fi .4s ease forwards;}
.bar-chart{display:flex;flex-direction:column;gap:9px;}
.bar-row{display:flex;align-items:center;gap:9px;}
.bar-label{font-size:11px;color:var(--text2);width:88px;flex-shrink:0;}
.bar-track{flex:1;height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;width:0;transition:width 1.2s cubic-bezier(.4,0,.2,1);}
.bar-num{font-size:12px;font-weight:600;font-family:'Syne',sans-serif;width:24px;text-align:right;}
.rank-item{display:flex;align-items:center;gap:11px;padding:11px 0;border-bottom:1px solid var(--border);}
.rank-item:last-child{border-bottom:none;}
.rank-n{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;width:22px;color:var(--text3);}
.gold{color:#ffd700}.silver{color:#c0c0c0}.bronze{color:#cd7f32}
.rank-info{flex:1;}
.rank-name{font-size:13px;font-weight:600;margin-bottom:2px;}
.rank-sub{font-size:11px;color:var(--text2);}
.rank-score{font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--accent);}
</style>
</head>
<body>
<!-- HOME -->
<div class="screen active" id="sc-home">
  <nav class="top-nav">
    <div class="nav-logo" onclick="adminTap()" id="home-logo-tap">
      <div class="nav-logo-icon">ğŸ›¡ï¸</div>
      <div class="nav-logo-text">EscazÃº<span>Seguro</span></div>
    </div>
    <span class="nav-badge" id="home-badge">â€¦ ALERTAS</span>
  </nav>
  <div class="page">
    <div class="hero fade-in">
      <div class="hero-greeting">Buenas, vecino ğŸ‘‹</div>
      <h1 class="hero-title">Cuida tu <em>comunidad</em><br>en tiempo real</h1>
      <div class="hero-status">
        <div class="pulse"></div>
        <span style="font-size:12px;color:var(--text2);" id="home-date">Zona EscazÃº Â· Activo</span>
      </div>
    </div>
    <div class="ticker-wrap fade-in">
      <span class="ticker-badge">EN VIVO</span>
      <div class="ticker-scroll" id="home-ticker">ğŸ”„ Cargando alertas...</div>
    </div>
    <p class="section-title">Emergencias</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px;" class="fade-in">
      <a href="tel:911" style="text-decoration:none;">
        <div style="background:rgba(255,82,82,.12);border:1px solid rgba(255,82,82,.3);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;">
          <div style="font-size:28px;margin-bottom:5px;">ğŸš¨</div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent2);">911</div>
          <div style="font-size:10px;color:var(--text2);margin-top:2px;">Emergencias</div>
        </div>
      </a>
      <a href="tel:1213" style="text-decoration:none;">
        <div style="background:rgba(68,138,255,.12);border:1px solid rgba(68,138,255,.3);border-radius:var(--radius);padding:16px;text-align:center;cursor:pointer;">
          <div style="font-size:28px;margin-bottom:5px;">ğŸ‘®</div>
          <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent4);">1213</div>
          <div style="font-size:10px;color:var(--text2);margin-top:2px;">PolicÃ­a Municipal</div>
        </div>
      </a>
    </div>
    <p class="section-title">Acciones rÃ¡pidas</p>
    <div class="quick-grid fade-in">
      <div class="quick-btn" onclick="goTo('report')"><span class="quick-icon">ğŸš¨</span>Reportar</div>
      <div class="quick-btn" onclick="goTo('alerts')"><span class="quick-icon">ğŸ””</span>Alertas</div>
      <div class="quick-btn" onclick="goTo('map')"><span class="quick-icon">ğŸ—ºï¸</span>Ver mapa</div>
      <div class="quick-btn" onclick="goTo('stats')"><span class="quick-icon">ğŸ“Š</span>EstadÃ­sticas</div>
    </div>
    <p class="section-title">Nivel de seguridad</p>
    <div class="card fade-in">
      <div class="score-ring-wrap">
        <div class="score-ring">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" fill="none" stroke="#1a2233" stroke-width="11"/>
            <circle cx="60" cy="60" r="50" fill="none" stroke="url(#g1)" stroke-width="11" stroke-dasharray="314.2" stroke-dashoffset="78" stroke-linecap="round" id="score-arc"/>
            <defs><linearGradient id="g1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#00e5a0"/><stop offset="100%" stop-color="#00b37a"/></linearGradient></defs>
          </svg>
          <div class="score-ring-val">
            <span class="score-num" id="score-num">â€”</span>
            <span class="score-unit">/ 100</span>
          </div>
        </div>
      </div>
      <div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;">
        <span class="pill pill-green" id="score-status">Cargando...</span>
        <span class="pill pill-yellow" id="score-active">â€¦</span>
      </div>
    </div>
    <p class="section-title">Alertas recientes</p>
    <div id="home-alerts-list"><div class="skeleton sk-item"></div><div class="skeleton sk-item"></div><div class="skeleton sk-item"></div></div>
    <div style="text-align:center;padding:10px;cursor:pointer;" onclick="goTo('alerts')">
      <span style="color:var(--accent);font-size:13px;font-weight:600;font-family:'Syne',sans-serif;">Ver todas las alertas â†’</span>
    </div>
    <p class="section-title">Resumen del mes</p>
    <div class="stat-grid fade-in">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent2)" id="stat-total">â€”</div><div class="stat-label">Reportes</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)" id="stat-resolved">â€”</div><div class="stat-label">Resueltos</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent3)" id="stat-pending">â€”</div><div class="stat-label">Pendientes</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent4)" id="stat-voters">â€”</div><div class="stat-label">Vecinos</div></div>
    </div>
  </div>
  <nav class="bottom-nav"><div class="nav-items">
    <button class="nav-item active" onclick="goTo('home')"><span class="nav-icon">ğŸ </span><span>Inicio</span></button>
    <button class="nav-item" onclick="goTo('alerts')"><span class="nav-icon" style="position:relative">ğŸ””<span class="nav-badge-count" style="display:none;position:absolute;top:-4px;right:-6px;background:var(--accent2);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;font-family:'Syne',sans-serif;"></span></span><span>Alertas</span></button>
    <button class="nav-item rep-btn" onclick="goTo('report')"><div class="rep-circle">ï¼‹</div></button>
    <button class="nav-item" onclick="goTo('map')"><span class="nav-icon">ğŸ—ºï¸</span><span>Mapa</span></button>
    <button class="nav-item" onclick="goTo('stats')"><span class="nav-icon">ğŸ“Š</span><span>Stats</span></button>
  </div></nav>
</div>

<!-- ALERTS -->
<div class="screen" id="sc-alerts">
  <nav class="top-nav">
    <div class="nav-logo" onclick="goTo('home')"><div class="nav-logo-icon">ğŸ›¡ï¸</div><div class="nav-logo-text">EscazÃº<span>Seguro</span></div></div>
    <span class="nav-badge" id="alerts-badge">â€¦</span>
  </nav>
  <div class="page">
    <div class="fade-in" style="margin-bottom:14px;">
      <div class="page-title">Centro de Alertas</div>
      <div class="page-sub">Reportes verificados en tiempo real</div>
    </div>
    <div class="filter-row fade-in">
      <button class="filter-tab on" onclick="filterAlerts(this,'all')">Todos</button>
      <button class="filter-tab" onclick="filterAlerts(this,'seguridad')">ğŸš¨ Seguridad</button>
      <button class="filter-tab" onclick="filterAlerts(this,'infraestructura')">ğŸ”§ Infra</button>
      <button class="filter-tab" onclick="filterAlerts(this,'ambiente')">ğŸŒ³ Ambiente</button>
      <button class="filter-tab" onclick="filterAlerts(this,'transito')">ğŸš— TrÃ¡nsito</button>
    </div>
    <div id="alerts-list"><div class="skeleton sk-item"></div><div class="skeleton sk-item"></div><div class="skeleton sk-item"></div><div class="skeleton sk-item"></div></div>
  </div>
  <nav class="bottom-nav"><div class="nav-items">
    <button class="nav-item" onclick="goTo('home')"><span class="nav-icon">ğŸ </span><span>Inicio</span></button>
    <button class="nav-item active" onclick="goTo('alerts')"><span class="nav-icon" style="position:relative">ğŸ””<span class="nav-badge-count" style="display:none;position:absolute;top:-4px;right:-6px;background:var(--accent2);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;font-family:'Syne',sans-serif;"></span></span><span>Alertas</span></button>
    <button class="nav-item rep-btn" onclick="goTo('report')"><div class="rep-circle">ï¼‹</div></button>
    <button class="nav-item" onclick="goTo('map')"><span class="nav-icon">ğŸ—ºï¸</span><span>Mapa</span></button>
    <button class="nav-item" onclick="goTo('stats')"><span class="nav-icon">ğŸ“Š</span><span>Stats</span></button>
  </div></nav>
</div>

<!-- MAP -->
<div class="screen" id="sc-map">
  <nav class="top-nav">
    <div class="nav-logo" onclick="goTo('home')"><div class="nav-logo-icon">ğŸ›¡ï¸</div><div class="nav-logo-text">EscazÃº<span>Seguro</span></div></div>
    <span class="nav-badge" id="map-badge">â€¦</span>
  </nav>
  <div class="page" style="padding-top:12px;">
    <div class="fade-in" style="margin-bottom:10px;"><div class="page-title">Mapa de Incidentes</div><div class="page-sub">Zonas coloreadas segÃºn nivel de riesgo</div></div>
    <div style="background:linear-gradient(135deg,#0a1520,#0d1e2f);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;position:relative;margin-bottom:11px;" class="fade-in">
      <svg width="100%" viewBox="0 0 400 340" id="map-svg" style="display:block;">
        <!-- Zonas de EscazÃº -->
        <!-- San Rafael -->
        <polygon id="zone-sanrafael" points="60,20 200,20 200,120 60,120" fill="rgba(0,229,160,0.15)" stroke="#00e5a0" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('San Rafael')"/>
        <!-- GuachipelÃ­n -->
        <polygon id="zone-guachi" points="200,20 350,20 350,120 200,120" fill="rgba(68,138,255,0.15)" stroke="#448aff" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('GuachipelÃ­n')"/>
        <!-- Trejos Montealegre -->
        <polygon id="zone-trejos" points="20,120 120,120 120,220 20,220" fill="rgba(0,229,160,0.15)" stroke="#00e5a0" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('Trejos Montealegre')"/>
        <!-- EscazÃº Centro -->
        <polygon id="zone-centro" points="120,120 260,120 260,220 120,220" fill="rgba(255,167,38,0.15)" stroke="#ffa726" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('EscazÃº Centro')"/>
        <!-- San Antonio -->
        <polygon id="zone-sanantonio" points="260,120 370,120 370,220 260,220" fill="rgba(255,82,82,0.15)" stroke="#ff5252" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('San Antonio')"/>
        <!-- Bello Horizonte -->
        <polygon id="zone-bello" points="20,220 160,220 160,310 20,310" fill="rgba(255,167,38,0.15)" stroke="#ffa726" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('Bello Horizonte')"/>
        <!-- Santa MarÃ­a -->
        <polygon id="zone-santa" points="160,220 370,220 370,310 160,310" fill="rgba(0,229,160,0.15)" stroke="#00e5a0" stroke-width="1.5" style="cursor:pointer;" onclick="zoneClick('Santa MarÃ­a')"/>

        <!-- Rutas -->
        <path d="M20,90 Q200,85 380,90" stroke="#1e3050" stroke-width="6" fill="none"/>
        <path d="M20,190 Q200,185 380,190" stroke="#1e3050" stroke-width="6" fill="none"/>
        <path d="M130,20 Q135,165 130,310" stroke="#1e3050" stroke-width="6" fill="none"/>
        <path d="M260,20 Q265,165 260,310" stroke="#1e3050" stroke-width="6" fill="none"/>

        <!-- Nombres de zonas -->
        <text x="130" y="65" fill="#e8edf5" font-size="11" text-anchor="middle" font-family="Syne" font-weight="700">San Rafael</text>
        <text x="275" y="65" fill="#e8edf5" font-size="11" text-anchor="middle" font-family="Syne" font-weight="700">GuachipelÃ­n</text>
        <text x="70" y="175" fill="#e8edf5" font-size="10" text-anchor="middle" font-family="Syne" font-weight="700">Trejos</text>
        <text x="190" y="175" fill="#e8edf5" font-size="11" text-anchor="middle" font-family="Syne" font-weight="700">EscazÃº Centro</text>
        <text x="315" y="175" fill="#e8edf5" font-size="11" text-anchor="middle" font-family="Syne" font-weight="700">San Antonio</text>
        <text x="90" y="265" fill="#e8edf5" font-size="10" text-anchor="middle" font-family="Syne" font-weight="700">Bello Horizonte</text>
        <text x="265" y="265" fill="#e8edf5" font-size="11" text-anchor="middle" font-family="Syne" font-weight="700">Santa MarÃ­a</text>

        <!-- Contadores por zona -->
        <text id="cnt-sanrafael" x="130" y="85" fill="#00e5a0" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-guachi" x="275" y="85" fill="#448aff" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-trejos" x="70" y="195" fill="#00e5a0" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-centro" x="190" y="195" fill="#ffa726" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-sanantonio" x="315" y="195" fill="#ff5252" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-bello" x="90" y="285" fill="#ffa726" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>
        <text id="cnt-santa" x="265" y="285" fill="#00e5a0" font-size="10" text-anchor="middle" font-family="Syne" font-weight="600"></text>

        <!-- Marcadores de reportes -->
        <g id="map-markers"></g>
      </svg>

      <!-- Leyenda -->
      <div style="position:absolute;bottom:8px;left:8px;background:rgba(10,14,20,.92);border:1px solid var(--border);border-radius:9px;padding:8px 10px;backdrop-filter:blur(8px);">
        <div style="font-size:9px;color:var(--text3);font-weight:700;letter-spacing:1px;margin-bottom:4px;">RIESGO</div>
        <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--text2);margin-bottom:3px;"><div style="width:10px;height:10px;border-radius:3px;background:rgba(255,82,82,0.5);"></div>Alto</div>
        <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--text2);margin-bottom:3px;"><div style="width:10px;height:10px;border-radius:3px;background:rgba(255,167,38,0.5);"></div>Medio</div>
        <div style="display:flex;align-items:center;gap:5px;font-size:9px;color:var(--text2);"><div style="width:10px;height:10px;border-radius:3px;background:rgba(0,229,160,0.5);"></div>Bajo</div>
      </div>
    </div>

    <!-- Info zona seleccionada -->
    <div id="zone-info" class="card fade-in" style="display:none;margin-bottom:11px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:800;" id="zone-name"></div>
        <span id="zone-badge" class="priority"></span>
      </div>
      <div id="zone-reports-list"></div>
    </div>

    <div style="display:flex;gap:8px;">
      <div class="stat-card" style="flex:1;text-align:center;padding:12px 4px;margin-bottom:0;"><div class="stat-val" style="color:var(--accent2);font-size:22px;" id="map-c-sec">â€”</div><div class="stat-label">Seguridad</div></div>
      <div class="stat-card" style="flex:1;text-align:center;padding:12px 4px;margin-bottom:0;"><div class="stat-val" style="color:var(--accent3);font-size:22px;" id="map-c-inf">â€”</div><div class="stat-label">Infra</div></div>
      <div class="stat-card" style="flex:1;text-align:center;padding:12px 4px;margin-bottom:0;"><div class="stat-val" style="color:var(--accent);font-size:22px;" id="map-c-env">â€”</div><div class="stat-label">Ambiente</div></div>
      <div class="stat-card" style="flex:1;text-align:center;padding:12px 4px;margin-bottom:0;"><div class="stat-val" style="color:var(--accent4);font-size:22px;" id="map-c-tra">â€”</div><div class="stat-label">TrÃ¡nsito</div></div>
    </div>
  </div>
  <nav class="bottom-nav"><div class="nav-items">
    <button class="nav-item" onclick="goTo('home')"><span class="nav-icon">ğŸ </span><span>Inicio</span></button>
    <button class="nav-item" onclick="goTo('alerts')"><span class="nav-icon" style="position:relative">ğŸ””<span class="nav-badge-count" style="display:none;position:absolute;top:-4px;right:-6px;background:var(--accent2);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;font-family:'Syne',sans-serif;"></span></span><span>Alertas</span></button>
    <button class="nav-item rep-btn" onclick="goTo('report')"><div class="rep-circle">ï¼‹</div></button>
    <button class="nav-item active" onclick="goTo('map')"><span class="nav-icon">ğŸ—ºï¸</span><span>Mapa</span></button>
    <button class="nav-item" onclick="goTo('stats')"><span class="nav-icon">ğŸ“Š</span><span>Stats</span></button>
  </div></nav>
</div>

<!-- REPORT -->
<div class="screen" id="sc-report">
  <nav class="top-nav">
    <div class="nav-logo" onclick="goTo('home')"><div class="nav-logo-icon">ğŸ›¡ï¸</div><div class="nav-logo-text">EscazÃº<span>Seguro</span></div></div>
    <span onclick="goTo('home')" style="font-size:20px;cursor:pointer;color:var(--text2);">âœ•</span>
  </nav>
  <div class="page" id="rep-page">
    <div class="fade-in" style="margin-bottom:18px;">
      <div class="page-title">Reportar Incidente</div>
      <div class="page-sub">Tu reporte llega a la base de datos en tiempo real</div>
    </div>
    <div class="steps fade-in">
      <div class="step act" id="rs1">1</div><div class="step-line" id="rl1"></div>
      <div class="step" id="rs2">2</div><div class="step-line" id="rl2"></div>
      <div class="step" id="rs3">3</div>
    </div>
    <div class="form-s act" id="rep-s1">
      <p class="section-title">Tipo de incidente</p>
      <div class="cat-grid">
        <button class="cat-btn" onclick="selCat(this,'ğŸš¨','seguridad')"><span class="cat-icon">ğŸš¨</span>Seguridad</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸ”§','infraestructura')"><span class="cat-icon">ğŸ”§</span>Infraestructura</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸŒ³','ambiente')"><span class="cat-icon">ğŸŒ³</span>Ambiente</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸš—','transito')"><span class="cat-icon">ğŸš—</span>TrÃ¡nsito</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸ’§','agua')"><span class="cat-icon">ğŸ’§</span>Agua</button>
        <button class="cat-btn" onclick="selCat(this,'âš¡','electricidad')"><span class="cat-icon">âš¡</span>Electricidad</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸ¥','salud')"><span class="cat-icon">ğŸ¥</span>Salud</button>
        <button class="cat-btn" onclick="selCat(this,'ğŸ“¢','otro')"><span class="cat-icon">ğŸ“¢</span>Otro</button>
      </div>
      <p class="section-title">Prioridad</p>
      <div class="prio-row">
        <button class="prio-btn" id="pb-h" onclick="selPrio('alta')">ğŸ”´ ALTA</button>
        <button class="prio-btn pm" id="pb-m" onclick="selPrio('media')">ğŸŸ¡ MEDIA</button>
        <button class="prio-btn" id="pb-l" onclick="selPrio('baja')">ğŸ”µ BAJA</button>
      </div>
      <button class="btn btn-primary" onclick="repStep(2)">Siguiente â†’</button>
    </div>
    <div class="form-s" id="rep-s2">
      <div class="input-group"><label class="input-label">TÃ­tulo del reporte</label><input class="input" type="text" id="rep-title" placeholder="Ej: Bache peligroso en Calle Vieja"></div>
      <div class="input-group"><label class="input-label">DescripciÃ³n detallada</label><textarea class="input" id="rep-desc" placeholder="Describe lo que ves con el mayor detalle posible..."></textarea></div>
      <div class="input-group"><label class="input-label">Distrito</label>
        <select class="input" id="rep-dist">
          <option value="">Seleccionar...</option>
          <option>EscazÃº Centro</option><option>San Rafael</option><option>San Antonio</option>
          <option>GuachipelÃ­n</option><option>Bello Horizonte</option><option>Trejos Montealegre</option>
          <option>Santa MarÃ­a</option><option>Otro</option>
        </select>
      </div>
      <div class="input-group"><label class="input-label">DirecciÃ³n / referencia</label><input class="input" type="text" id="rep-addr" placeholder="Ej: 200m norte del CIMA"></div>
      <button class="loc-btn" id="loc-btn" onclick="getLocation()"><span style="font-size:19px">ğŸ“</span><span>Usar mi ubicaciÃ³n actual</span></button>
      <div class="btn-2col"><button class="btn btn-ghost" onclick="repStep(1)">â† AtrÃ¡s</button><button class="btn btn-primary" onclick="repStep(3)">Siguiente â†’</button></div>
    </div>
    <div class="form-s" id="rep-s3">
      <div class="upload-zone" onclick="fakeUpload()">
        <div id="up-icon" style="font-size:30px;margin-bottom:7px;">ğŸ“·</div>
        <div id="up-text" style="font-size:13px;color:var(--text2);">Subir foto del incidente</div>
        <div style="font-size:11px;color:var(--text3);margin-top:3px;">JPG, PNG, MP4 Â· MÃ¡x 20MB</div>
      </div>
      <div class="input-group"><label class="input-label">Tu nombre (opcional)</label><input class="input" type="text" id="rep-name" placeholder="AnÃ³nimo"></div>
      <div class="input-group"><label class="input-label">CÃ©dula <span style="color:var(--accent2)">*</span></label><input class="input" type="text" id="rep-cedula" placeholder="Ej: 1-1234-5678" required></div>
      <div class="input-group"><label class="input-label">TelÃ©fono <span style="color:var(--accent2)">*</span></label><input class="input" type="tel" id="rep-phone" placeholder="+506 8888-8888" required></div>
      <div class="card" style="background:rgba(0,229,160,.04);border-color:rgba(0,229,160,.15);margin-bottom:13px;">
        <p style="font-family:'Syne',sans-serif;font-size:10px;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-bottom:9px;">Resumen del reporte</p>
        <div id="sum-cat" style="font-size:13px;margin-bottom:5px;"></div>
        <div id="sum-title" style="font-size:12px;color:var(--text2);margin-bottom:3px;"></div>
        <div id="sum-loc" style="font-size:12px;color:var(--text2);"></div>
      </div>
      <div class="btn-2col" style="margin-bottom:8px;">
        <button class="btn btn-ghost" onclick="repStep(2)">â† AtrÃ¡s</button>
        <button class="btn btn-primary" id="submit-btn" onclick="validarYEnviar()">ğŸš€ Enviar</button>
      </div>
      <p style="font-size:10px;color:var(--text3);text-align:center;line-height:1.5;">Al enviar confirmÃ¡s que la informaciÃ³n es verÃ­dica.</p>
    </div>
  </div>
  <div class="success-view" id="rep-success">
    <div class="success-icon">âœ…</div>
    <h2 style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;margin-bottom:9px;">Â¡Reporte enviado!</h2>
    <p style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:22px;max-width:280px;">Tu reporte fue guardado en la base de datos y ya es visible para toda la comunidad.</p>
    <div class="ticket-no">TICKET #ESC-<span id="ticket-num">00000</span></div>
    <button class="btn btn-primary" style="max-width:220px;" onclick="goTo('alerts')">Ver alertas activas</button>
    <div style="margin-top:14px;color:var(--text2);font-size:13px;cursor:pointer;" onclick="goTo('home')">Volver al inicio</div>
  </div>
  <nav class="bottom-nav"><div class="nav-items">
    <button class="nav-item" onclick="goTo('home')"><span class="nav-icon">ğŸ </span><span>Inicio</span></button>
    <button class="nav-item" onclick="goTo('alerts')"><span class="nav-icon" style="position:relative">ğŸ””<span class="nav-badge-count" style="display:none;position:absolute;top:-4px;right:-6px;background:var(--accent2);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;font-family:'Syne',sans-serif;"></span></span><span>Alertas</span></button>
    <button class="nav-item rep-btn active" onclick="goTo('report')"><div class="rep-circle">ï¼‹</div></button>
    <button class="nav-item" onclick="goTo('map')"><span class="nav-icon">ğŸ—ºï¸</span><span>Mapa</span></button>
    <button class="nav-item" onclick="goTo('stats')"><span class="nav-icon">ğŸ“Š</span><span>Stats</span></button>
  </div></nav>
</div>

<!-- STATS -->
<div class="screen" id="sc-stats">
  <nav class="top-nav">
    <div class="nav-logo" onclick="goTo('home')"><div class="nav-logo-icon">ğŸ›¡ï¸</div><div class="nav-logo-text">EscazÃº<span>Seguro</span></div></div>
    <span id="db-status-badge" class="db-status db-ok">â— DB conectada</span>
  </nav>
  <div class="page">
    <div class="fade-in" style="margin-bottom:14px;"><div class="page-title">EstadÃ­sticas</div><div class="page-sub">Datos reales de la comunidad</div></div>
    <div class="stat-grid fade-in">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent2)" id="s-total">â€”</div><div class="stat-label">Reportes totales</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)" id="s-resolved">â€”</div><div class="stat-label">Resueltos</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent3)" id="s-pending">â€”</div><div class="stat-label">Pendientes</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent4)" id="s-voters">â€”</div><div class="stat-label">Votos totales</div></div>
    </div>
    <p class="section-title">Por tipo de incidente</p>
    <div class="card fade-in"><div class="bar-chart" id="type-bars"><div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Cargando...</div></div></div>
    <p class="section-title">Por distrito</p>
    <div class="card fade-in"><div class="bar-chart" id="district-bars"><div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Cargando...</div></div></div>
    <p class="section-title">Top reporteros del mes ğŸ†</p>
    <div class="card fade-in" id="top-reporters"><div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Cargando...</div></div>
    <div class="card" style="background:linear-gradient(135deg,rgba(0,229,160,.08),rgba(68,138,255,.05));border-color:rgba(0,229,160,.15);text-align:center;margin-bottom:6px;">
      <div style="font-size:26px;margin-bottom:7px;">ğŸ…</div>
      <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:5px;">Â¡SÃ© parte del cambio!</div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:13px;">Cada reporte suma para hacer EscazÃº mÃ¡s seguro</div>
      <button class="btn btn-primary" style="max-width:180px;margin:0 auto;" onclick="goTo('report')">Reportar ahora</button>
    </div>
  </div>
  <nav class="bottom-nav"><div class="nav-items">
    <button class="nav-item" onclick="goTo('home')"><span class="nav-icon">ğŸ </span><span>Inicio</span></button>
    <button class="nav-item" onclick="goTo('alerts')"><span class="nav-icon" style="position:relative">ğŸ””<span class="nav-badge-count" style="display:none;position:absolute;top:-4px;right:-6px;background:var(--accent2);color:white;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;font-family:'Syne',sans-serif;"></span></span><span>Alertas</span></button>
    <button class="nav-item rep-btn" onclick="goTo('report')"><div class="rep-circle">ï¼‹</div></button>
    <button class="nav-item" onclick="goTo('map')"><span class="nav-icon">ğŸ—ºï¸</span><span>Mapa</span></button>
    <button class="nav-item active" onclick="goTo('stats')"><span class="nav-icon">ğŸ“Š</span><span>Stats</span></button>
  </div></nav>
</div>

<!-- ADMIN PANEL -->
<div class="screen" id="sc-admin">
  <nav class="top-nav">
    <div class="nav-logo"><div class="nav-logo-icon">âš™ï¸</div><div class="nav-logo-text">Panel <span>Admin</span></div></div>
    <span onclick="cerrarAdmin()" style="font-size:13px;cursor:pointer;color:var(--accent2);font-weight:700;font-family:'Syne',sans-serif;">SALIR</span>
  </nav>
  <div class="page">
    <div class="fade-in" style="margin-bottom:14px;">
      <div class="page-title">Panel de AdministraciÃ³n</div>
      <div class="page-sub">GestiÃ³n de reportes ciudadanos</div>
    </div>
    <div class="stat-grid fade-in">
      <div class="stat-card"><div class="stat-val" style="color:var(--accent2)" id="adm-total">â€”</div><div class="stat-label">Total</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent3)" id="adm-activos">â€”</div><div class="stat-label">Activos</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent4)" id="adm-proceso">â€”</div><div class="stat-label">En proceso</div></div>
      <div class="stat-card"><div class="stat-val" style="color:var(--accent)" id="adm-resueltos">â€”</div><div class="stat-label">Resueltos</div></div>
    </div>
    <p class="section-title">Gestionar reportes</p>
    <div id="admin-list"></div>
  </div>
</div>
<div class="sheet-overlay" id="sheet" onclick="closeSheet(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div style="display:flex;align-items:flex-start;gap:13px;margin-bottom:14px;">
      <div class="alert-icon" id="sh-icon" style="width:48px;height:48px;font-size:22px;flex-shrink:0;"></div>
      <div><div id="sh-title" style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;line-height:1.25;margin-bottom:6px;"></div>
      <div style="display:flex;gap:7px;flex-wrap:wrap;"><span id="sh-prio" class="priority"></span><span id="sh-time" class="pill pill-blue" style="font-size:10px;"></span></div></div>
    </div>
    <div style="background:var(--bg3);border-radius:9px;padding:11px;margin-bottom:12px;">
      <div style="font-size:10px;color:var(--text3);margin-bottom:3px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;">ğŸ“ UbicaciÃ³n</div>
      <div id="sh-loc" style="font-size:13px;"></div>
    </div>
    <div id="sh-desc" style="font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:14px;"></div>
    <img id="sh-photo" style="display:none;width:100%;border-radius:10px;margin-bottom:14px;object-fit:cover;max-height:200px;" />
    <div style="display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:14px;">
      <div><div style="font-size:10px;color:var(--text3);margin-bottom:2px;">Estado</div><div id="sh-status" style="font-size:13px;font-weight:600;color:var(--accent);"></div></div>
      <div style="text-align:right;"><div style="font-size:10px;color:var(--text3);margin-bottom:2px;">Votos</div><div id="sh-votes" style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--accent);"></div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px;">
      <button class="btn btn-primary" id="sh-vote-btn" onclick="voteFromSheet()">ğŸ‘ Confirmar</button>
      <button class="btn btn-ghost" onclick="showToast('ğŸ“¤ Enlace copiado')">ğŸ”— Compartir</button>
    </div>
    <button class="btn btn-ghost" style="border-color:rgba(255,82,82,.3);color:var(--accent2);" onclick="deleteFromSheet()">ğŸ—‘ï¸ Eliminar reporte</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let sb = null;
let dbOk = false;
let currentFilter = 'all';
let allReports = [];
let currentSheetReport = null;
let userLat = null, userLng = null;
let selCatData = { icon: 'ğŸ“¢', label: 'otro' };
let selPrioData = 'media';

const catIcon = { seguridad:'ğŸš¨', infraestructura:'ğŸ”§', ambiente:'ğŸŒ³', transito:'ğŸš—', agua:'ğŸ’§', electricidad:'âš¡', salud:'ğŸ¥', otro:'ğŸ“¢' };
const catCls = { seguridad:'ai-sec', infraestructura:'ai-inf', ambiente:'ai-env', transito:'ai-tra', agua:'ai-inf', electricidad:'ai-inf', salud:'ai-sec', otro:'ai-tra' };
const catColor = { seguridad:'#ff5252', infraestructura:'#ffa726', ambiente:'#00e5a0', transito:'#448aff', agua:'#448aff', electricidad:'#ffa726', salud:'#ff5252', otro:'#8b5cf6' };
const mapCoords = { 'GuachipelÃ­n':{x:290,y:65}, 'San Rafael':{x:160,y:55}, 'EscazÃº Centro':{x:240,y:170}, 'Bello Horizonte':{x:95,y:175}, 'Trejos Montealegre':{x:60,y:100}, 'San Antonio':{x:268,y:158}, 'Santa MarÃ­a':{x:180,y:220}, 'Otro':{x:200,y:130} };

function initSupabase() {
  try {
    if (typeof supabase === 'undefined') {
      console.warn('Supabase library not loaded');
      dbOk = false;
      loadDemoData();
      return;
    }
    sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    dbOk = true;
    console.log('âœ… Supabase conectado');
    loadAllData();
    sb.channel('reportes-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'reportes' }, (payload) => {
        if (payload.eventType === 'INSERT' && payload.new) {
          notificarNuevoReporte(payload.new.titulo, payload.new.categoria, payload.new.distrito);
          incrementarBadge();
        }
        loadAllData();
      })
      .subscribe();
  } catch(e) {
    console.error('Error Supabase:', e);
    dbOk = false;
    loadDemoData();
  }
}

function loadDemoData() {
  allReports = [
    { id:1, titulo:'Robo de vehÃ­culo en GuachipelÃ­n', descripcion:'Toyota Corolla plata. Placa BJK-448.', categoria:'seguridad', prioridad:'alta', distrito:'GuachipelÃ­n', direccion:'Frente al Multiplaza', estado:'activo', votos:14, nombre_reportero:'Juan C.', created_at: new Date(Date.now()-23*60000).toISOString() },
    { id:2, titulo:'Ãrbol caÃ­do en Ruta 27', descripcion:'Bloquea carril derecho. Municipalidad notificada.', categoria:'ambiente', prioridad:'media', distrito:'San Rafael', direccion:'Salida EscazÃº', estado:'en_proceso', votos:7, nombre_reportero:'Vecinos SR', created_at: new Date(Date.now()-70*60000).toISOString() },
    { id:3, titulo:'Alumbrado pÃºblico apagado', descripcion:'3 postes sin luz. Zona oscura.', categoria:'infraestructura', prioridad:'baja', distrito:'EscazÃº Centro', direccion:'Av. Central frente al CIMA', estado:'activo', votos:5, nombre_reportero:'MarÃ­a L.', created_at: new Date(Date.now()-3*3600000).toISOString() },
    { id:4, titulo:'Accidente en Bello Horizonte', descripcion:'ColisiÃ³n menor. Sin heridos.', categoria:'transito', prioridad:'media', distrito:'Bello Horizonte', direccion:'Entrada principal', estado:'resuelto', votos:11, nombre_reportero:'Patrulla #04', created_at: new Date(Date.now()-4*3600000).toISOString() },
    { id:5, titulo:'Deslizamiento en Trejos Montealegre', descripcion:'Camino vecinal bloqueado.', categoria:'ambiente', prioridad:'alta', distrito:'Trejos Montealegre', direccion:'Camino viejo', estado:'en_proceso', votos:19, nombre_reportero:'CNE EscazÃº', created_at: new Date(Date.now()-26*3600000).toISOString() },
    { id:6, titulo:'Bache peligroso Calle Vieja', descripcion:'Hueco profundo. DaÃ±os a vehÃ­culos.', categoria:'infraestructura', prioridad:'media', distrito:'San Antonio', direccion:'Calle Vieja km 3', estado:'activo', votos:8, nombre_reportero:'Luis M.', created_at: new Date(Date.now()-27*3600000).toISOString() },
  ];
  updateUI();
}

async function loadAllData() {
  try {
    const { data, error } = await sb.from('reportes').select('*').order('created_at', { ascending: false }).limit(50);
    if (error) throw error;
    allReports = data || [];
    updateUI();
    updateDBStatus(true);
  } catch(e) {
    console.error('Error cargando datos:', e);
    updateDBStatus(false);
    if (allReports.length === 0) loadDemoData();
  }
}

function updateDBStatus(ok) {
  const el = document.getElementById('db-status-badge');
  if (!el) return;
  el.textContent = ok ? 'â— DB conectada' : 'â— Sin conexiÃ³n';
  el.className = 'db-status ' + (ok ? 'db-ok' : 'db-err');
}

function updateUI() {
  renderHomeAlerts();
  renderAlertsList();
  renderMapMarkers();
  renderStats();
  updateHomeStats();
  updateTicker();
}

function updateHomeStats() {
  const total = allReports.length;
  const resolved = allReports.filter(r=>r.estado==='resuelto').length;
  const pending = allReports.filter(r=>r.estado!=='resuelto').length;
  const voters = allReports.reduce((a,r)=>a+(r.votos||0), 0);
  const active = allReports.filter(r=>r.estado!=='resuelto').length;
  setEl('stat-total', total); setEl('stat-resolved', resolved);
  setEl('stat-pending', pending); setEl('stat-voters', voters);
  setEl('home-badge', active + ' ALERTAS');
  let score = 100;
  allReports.filter(r=>r.estado!=='resuelto').forEach(r=>{
    if(r.prioridad==='alta') score -= 4;
    else if(r.prioridad==='media') score -= 2;
    else score -= 1;
  });
  score = Math.max(10, Math.min(100, score));
  setEl('score-num', score);
  const arc = document.getElementById('score-arc');
  if(arc) arc.setAttribute('stroke-dashoffset', 314.2 * (1 - score/100));
  setEl('score-status', score >= 70 ? 'Seguridad Normal' : score >= 40 ? 'Alerta Moderada' : 'âš ï¸ Alerta Alta');
  setEl('score-active', active + ' incidentes activos');
}

function updateTicker() {
  const ticker = document.getElementById('home-ticker');
  if (!ticker || allReports.length === 0) return;
  const items = allReports.slice(0,6).map(r=>`${catIcon[r.categoria]||'ğŸ“¢'} ${r.titulo} Â· ${r.distrito}`).join(' &nbsp;Â·&nbsp; ');
  ticker.innerHTML = items + ' &nbsp;Â·&nbsp; ' + items;
}

function renderHomeAlerts() {
  const list = document.getElementById('home-alerts-list');
  if (!list) return;
  const recent = allReports.filter(r=>r.estado!=='resuelto').slice(0,3);
  list.innerHTML = recent.length ? recent.map(r=>alertHTML(r)).join('') : '<div style="color:var(--text3);text-align:center;padding:20px;font-size:13px;">Â¡Sin alertas activas! ğŸ‰</div>';
}

function renderAlertsList() {
  const list = document.getElementById('alerts-list');
  if (!list) return;
  const filtered = currentFilter === 'all' ? allReports : allReports.filter(r=>r.categoria===currentFilter);
  const badge = document.getElementById('alerts-badge');
  if(badge) badge.textContent = allReports.filter(r=>r.estado!=='resuelto').length + ' ACTIVAS';
  list.innerHTML = filtered.length ? filtered.map(r=>alertHTML(r)).join('') : '<div style="color:var(--text3);text-align:center;padding:30px;font-size:13px;">Sin reportes en esta categorÃ­a</div>';
}

function alertHTML(r) {
  const prioCls = { alta:'p-high', media:'p-med', baja:'p-low' };
  const icon = catIcon[r.categoria] || 'ğŸ“¢';
  const cls = catCls[r.categoria] || 'ai-tra';
  const prio = prioCls[r.prioridad] || 'p-low';
  const time = timeAgo(r.created_at);
  return `<div class="alert-item" onclick='openSheet(${JSON.stringify(r)})'>
    <div class="alert-icon ${cls}">${icon}</div>
    <div class="alert-body">
      <div class="alert-title">${escHtml(r.titulo)}</div>
      <div class="alert-meta"><span>${escHtml(r.distrito||'')}</span><span>Â·</span><span>${time}</span><span class="priority ${prio}">${(r.prioridad||'').toUpperCase()}</span></div>
      <div class="alert-desc">${escHtml((r.descripcion||'').substring(0,80))}${r.descripcion&&r.descripcion.length>80?'...':''}</div>
    </div>
    <div class="alert-votes">
      <button class="vote-btn ${r._voted?'voted':''}" onclick="event.stopPropagation();voteReport(${r.id},this)">â–²</button>
      <span class="vote-count">${r.votos||0}</span>
    </div>
  </div>`;
}

function filterAlerts(btn, cat) {
  document.querySelectorAll('#sc-alerts .filter-tab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  currentFilter = cat;
  renderAlertsList();
}

function renderMapMarkers() {
  const active = allReports.filter(r=>r.estado!=='resuelto');
  setEl('map-c-sec', active.filter(r=>r.categoria==='seguridad').length);
  setEl('map-c-inf', active.filter(r=>['infraestructura','agua','electricidad'].includes(r.categoria)).length);
  setEl('map-c-env', active.filter(r=>r.categoria==='ambiente').length);
  setEl('map-c-tra', active.filter(r=>r.categoria==='transito').length);
  setEl('map-badge', active.length + ' EN MAPA');

  const zones = {
    'San Rafael':      { id:'sanrafael', color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-sanrafael' },
    'GuachipelÃ­n':     { id:'guachi',    color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-guachi' },
    'Trejos Montealegre':{ id:'trejos',  color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-trejos' },
    'EscazÃº Centro':   { id:'centro',    color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-centro' },
    'San Antonio':     { id:'sanantonio',color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-sanantonio' },
    'Bello Horizonte': { id:'bello',     color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-bello' },
    'Santa MarÃ­a':     { id:'santa',     color_low:'rgba(0,229,160,0.15)', color_med:'rgba(255,167,38,0.25)', color_high:'rgba(255,82,82,0.35)', stroke_low:'#00e5a0', stroke_med:'#ffa726', stroke_high:'#ff5252', cnt:'cnt-santa' },
  };

  Object.entries(zones).forEach(([name, z]) => {
    const reps = active.filter(r=>r.distrito===name);
    const highCount = reps.filter(r=>r.prioridad==='alta').length;
    const el = document.getElementById('zone-'+z.id);
    const cnt = document.getElementById(z.cnt);
    if (!el) return;
    let level = 'low';
    if (highCount >= 2 || reps.length >= 4) level = 'high';
    else if (reps.length >= 2 || highCount >= 1) level = 'med';
    el.setAttribute('fill', z['color_'+level]);
    el.setAttribute('stroke', z['stroke_'+level]);
    if (cnt) cnt.textContent = reps.length > 0 ? reps.length + ' reporte' + (reps.length!==1?'s':'') : '';
  });

  // Marcadores
  const mapCoords = {
    'San Rafael':{x:130,y:70}, 'GuachipelÃ­n':{x:275,y:70},
    'Trejos Montealegre':{x:70,y:170}, 'EscazÃº Centro':{x:190,y:170},
    'San Antonio':{x:315,y:170}, 'Bello Horizonte':{x:90,y:265},
    'Santa MarÃ­a':{x:265,y:265}, 'Otro':{x:200,y:160}
  };
  const g = document.getElementById('map-markers');
  if (!g) return;
  const placed = {};
  g.innerHTML = active.map(r => {
    const base = mapCoords[r.distrito] || {x:200,y:160};
    placed[r.distrito] = (placed[r.distrito]||0) + 1;
    const offset = placed[r.distrito] - 1;
    const x = base.x + (offset % 3) * 16 - 16;
    const y = base.y + Math.floor(offset/3) * 16;
    const color = catColor[r.categoria] || '#8b5cf6';
    const icon = catIcon[r.categoria] || 'ğŸ“¢';
    return `<g style="cursor:pointer" onclick='openSheet(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
      <circle cx="${x}" cy="${y}" r="9" fill="${color}" fill-opacity="0.9"/>
      <text x="${x}" y="${y+4}" text-anchor="middle" font-size="9">${icon}</text>
    </g>`;
  }).join('');
}

function zoneClick(name) {
  const reps = allReports.filter(r=>r.distrito===name && r.estado!=='resuelto');
  const info = document.getElementById('zone-info');
  const zoneName = document.getElementById('zone-name');
  const zoneBadge = document.getElementById('zone-badge');
  const zoneList = document.getElementById('zone-reports-list');
  if (!info) return;
  zoneName.textContent = 'ğŸ“ ' + name;
  const high = reps.filter(r=>r.prioridad==='alta').length;
  let nivel, cls;
  if (high >= 2 || reps.length >= 4) { nivel='RIESGO ALTO'; cls='p-high'; }
  else if (reps.length >= 2 || high >= 1) { nivel='RIESGO MEDIO'; cls='p-med'; }
  else { nivel='RIESGO BAJO'; cls='p-low'; }
  zoneBadge.textContent = nivel;
  zoneBadge.className = 'priority ' + cls;
  if (!reps.length) {
    zoneList.innerHTML = '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">âœ… Sin incidentes activos</div>';
  } else {
    zoneList.innerHTML = reps.map(r=>`
      <div style="display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick='openSheet(${JSON.stringify(r).replace(/'/g,"&#39;")})'>
        <div class="alert-icon ${catCls[r.categoria]||'ai-tra'}" style="width:32px;height:32px;font-size:15px;flex-shrink:0;">${catIcon[r.categoria]||'ğŸ“¢'}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(r.titulo)}</div>
          <div style="font-size:10px;color:var(--text2);">${timeAgo(r.created_at)}</div>
        </div>
        <span class="priority ${r.prioridad==='alta'?'p-high':r.prioridad==='media'?'p-med':'p-low'}">${(r.prioridad||'').toUpperCase()}</span>
      </div>`).join('');
  }
  info.style.display = 'block';
  info.scrollIntoView({behavior:'smooth', block:'nearest'});
}

function renderStats() {
  const total = allReports.length;
  const resolved = allReports.filter(r=>r.estado==='resuelto').length;
  const pending = allReports.filter(r=>r.estado!=='resuelto').length;
  const votes = allReports.reduce((a,r)=>a+(r.votos||0),0);
  setEl('s-total',total); setEl('s-resolved',resolved); setEl('s-pending',pending); setEl('s-voters',votes);
  const types = {};
  allReports.forEach(r=>{ types[r.categoria]=(types[r.categoria]||0)+1; });
  const sortedTypes = Object.entries(types).sort((a,b)=>b[1]-a[1]);
  const maxT = sortedTypes[0]?.[1] || 1;
  const colors = { seguridad:'#ff5252', infraestructura:'#ffa726', ambiente:'#00e5a0', transito:'#448aff', agua:'#448aff', electricidad:'#8b5cf6', salud:'#ff5252', otro:'#8b8b8b' };
  const typeBars = document.getElementById('type-bars');
  if(typeBars) typeBars.innerHTML = sortedTypes.length ? sortedTypes.map(([cat,n])=>`
    <div class="bar-row">
      <span class="bar-label">${catIcon[cat]||'ğŸ“¢'} ${cat.charAt(0).toUpperCase()+cat.slice(1)}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/maxT*100)}%;background:${colors[cat]||'#8b8b8b'}"></div></div>
      <span class="bar-num">${n}</span>
    </div>`).join('') : '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Sin datos aÃºn</div>';
  const dists = {};
  allReports.forEach(r=>{ if(r.distrito) dists[r.distrito]=(dists[r.distrito]||0)+1; });
  const sortedDists = Object.entries(dists).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const maxD = sortedDists[0]?.[1] || 1;
  const distColors = ['#ff5252','#ffa726','#00e5a0','#448aff','#8b5cf6'];
  const distBars = document.getElementById('district-bars');
  if(distBars) distBars.innerHTML = sortedDists.length ? sortedDists.map(([d,n],i)=>`
    <div class="bar-row">
      <span class="bar-label">${d}</span>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(n/maxD*100)}%;background:${distColors[i]}"></div></div>
      <span class="bar-num">${n}</span>
    </div>`).join('') : '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Sin datos aÃºn</div>';
  const reporters = {};
  allReports.forEach(r=>{ if(r.nombre_reportero) reporters[r.nombre_reportero]=(reporters[r.nombre_reportero]||0)+1; });
  const topR = Object.entries(reporters).sort((a,b)=>b[1]-a[1]).slice(0,4);
  const medals = ['gold','silver','bronze',''];
  const topEl = document.getElementById('top-reporters');
  if(topEl) topEl.innerHTML = topR.length ? topR.map(([name,count],i)=>`
    <div class="rank-item">
      <div class="rank-n ${medals[i]}">${i+1}</div>
      <div class="rank-info"><div class="rank-name">${escHtml(name)}</div><div class="rank-sub">${count} reporte${count!==1?'s':''}</div></div>
      <div class="rank-score">â­ ${count*30}</div>
    </div>`).join('') : '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">Sin reportes aÃºn. Â¡SÃ© el primero!</div>';
}

function openSheet(r) {
  if (typeof r === 'string') r = JSON.parse(r);
  currentSheetReport = r;
  const prioCls = { alta:'p-high', media:'p-med', baja:'p-low' };
  const icon = catIcon[r.categoria]||'ğŸ“¢';
  const el = document.getElementById('sh-icon');
  el.textContent = icon;
  el.className = 'alert-icon ' + (catCls[r.categoria]||'ai-tra');
  document.getElementById('sh-title').textContent = r.titulo;
  document.getElementById('sh-time').textContent = r.distrito + ' Â· ' + timeAgo(r.created_at);
  document.getElementById('sh-loc').textContent = (r.distrito||'') + (r.direccion?', '+r.direccion:'');
  document.getElementById('sh-desc').textContent = r.descripcion||'';
  const photoEl = document.getElementById('sh-photo');
  if (r.foto_url) {
    photoEl.src = r.foto_url;
    photoEl.style.display = 'block';
  } else {
    photoEl.style.display = 'none';
  }
  const p = document.getElementById('sh-prio');
  p.textContent = (r.prioridad||'').toUpperCase();
  p.className = 'priority '+(prioCls[r.prioridad]||'p-low');
  document.getElementById('sh-status').textContent = r.estado==='resuelto'?'âœ… Resuelto':r.estado==='en_proceso'?'âš™ï¸ En proceso':'ğŸ”´ Activo';
  document.getElementById('sh-votes').textContent = r.votos||0;
  document.getElementById('sheet').classList.add('open');
}

function closeSheet(e) { if(e.target===document.getElementById('sheet')) document.getElementById('sheet').classList.remove('open'); }
function closeSheetDirect() { document.getElementById('sheet').classList.remove('open'); }
async function voteFromSheet() { if (!currentSheetReport) return; await voteReportById(currentSheetReport.id); closeSheetDirect(); }
function deleteFromSheet() { if (!currentSheetReport) return; deleteReport(currentSheetReport.id); }

async function voteReport(id, btn) {
  const countEl = btn.parentElement.querySelector('.vote-count');
  if (btn.classList.contains('voted')) return;
  btn.classList.add('voted');
  countEl.textContent = parseInt(countEl.textContent) + 1;
  showToast('âœ… Voto registrado');
  await voteReportById(id);
}

async function voteReportById(id) {
  const report = allReports.find(r=>r.id===id);
  if (!report) return;
  const newVotes = (report.votos||0) + 1;
  report.votos = newVotes;
  report._voted = true;
  if (dbOk && sb) {
    try { await sb.from('reportes').update({ votos: newVotes }).eq('id', id); }
    catch(e) { console.error('Error al votar:', e); }
  }
}

function validarYEnviar() {
  const cedula = document.getElementById('rep-cedula').value.trim();
  const phone = document.getElementById('rep-phone').value.trim();

  if (!cedula) { showToast('âš ï¸ La cÃ©dula es obligatoria', true); document.getElementById('rep-cedula').focus(); return; }
  const cedulaLimpia = cedula.replace(/[-\s]/g, '');
  const cedulaFisica = /^[1-9]\d{8}$/.test(cedulaLimpia);
  const cedulaJuridica = /^3\d{9}$/.test(cedulaLimpia);
  const cedulaResidente = /^[157]\d{11}$/.test(cedulaLimpia);
  if (!cedulaFisica && !cedulaJuridica && !cedulaResidente) {
    showToast('âš ï¸ CÃ©dula invÃ¡lida. Ej: 1-1234-5678', true);
    document.getElementById('rep-cedula').focus(); return;
  }

  if (!phone) { showToast('âš ï¸ El telÃ©fono es obligatorio', true); document.getElementById('rep-phone').focus(); return; }
  const phoneLimpio = phone.replace(/[\s\-\+]/g, '');
  if (!/^\d{8,11}$/.test(phoneLimpio)) {
    showToast('âš ï¸ TelÃ©fono invÃ¡lido. Ej: 88888888', true);
    document.getElementById('rep-phone').focus(); return;
  }

  submitReport();
}

async function submitReport() {
  const title = document.getElementById('rep-title').value.trim();
  const dist = document.getElementById('rep-dist').value;
  const cedula = document.getElementById('rep-cedula').value.trim();
  const phone = document.getElementById('rep-phone').value.trim();
  if (!title) { showToast('âš ï¸ IngresÃ¡ un tÃ­tulo', true); return; }
  if (!dist) { showToast('âš ï¸ SeleccionÃ¡ un distrito', true); return; }
  if (!cedula) { showToast('âš ï¸ La cÃ©dula es obligatoria', true); return; }
  const cedulaLimpia = cedula.replace(/[-\s]/g, '');
  const cedulaFisica = /^[1-9]\d{8}$/.test(cedulaLimpia);
  const cedulaJuridica = /^3\d{9}$/.test(cedulaLimpia);
  const cedulaResidente = /^[157]\d{11}$/.test(cedulaLimpia);
  if (!cedulaFisica && !cedulaJuridica && !cedulaResidente) {
    showToast('âš ï¸ CÃ©dula invÃ¡lida. Ej: 1-1234-5678', true); return;
  }
  if (!phone) { showToast('âš ï¸ El telÃ©fono es obligatorio', true); return; }
  const phoneLimpio = phone.replace(/[\s\-\+]/g, '');
  if (!/^\d{8,11}$/.test(phoneLimpio)) {
    showToast('âš ï¸ TelÃ©fono invÃ¡lido. Ej: 88888888', true); return;
  }  const btn = document.getElementById('submit-btn');
  btn.textContent = 'â³ Enviando...'; btn.disabled = true;
  const newReport = {
    titulo: title,
    descripcion: document.getElementById('rep-desc').value.trim(),
    categoria: selCatData.label, prioridad: selPrioData, distrito: dist,
    direccion: document.getElementById('rep-addr').value.trim(),
    nombre_reportero: document.getElementById('rep-name').value.trim() || 'AnÃ³nimo',
    telefono: document.getElementById('rep-phone').value.trim(),
    cedula: document.getElementById('rep-cedula').value.trim(),
    estado: 'activo', votos: 0, lat: userLat, lng: userLng,
    foto_url: uploadedPhotoUrl || null,
  };
  let ticketId;
  if (dbOk && sb) {
    try {
      const { data, error } = await sb.from('reportes').insert([newReport]).select();
      if (error) throw error;
      ticketId = data[0]?.id || Math.floor(10000+Math.random()*90000);
      allReports.unshift({ ...newReport, id: ticketId, created_at: new Date().toISOString() });
      notificarNuevoReporte(newReport.titulo, newReport.categoria, newReport.distrito);
      incrementarBadge();
      updateUI();
    } catch(e) {
      console.error('Error al guardar:', e);
      showToast('âŒ Error al guardar. ReintentÃ¡.', true);
      btn.textContent = 'ğŸš€ Enviar'; btn.disabled = false; return;
    }
  } else {
    ticketId = Math.floor(10000+Math.random()*90000);
    allReports.unshift({ ...newReport, id: ticketId, created_at: new Date().toISOString() });
    notificarNuevoReporte(newReport.titulo, newReport.categoria, newReport.distrito);
    incrementarBadge();
    updateUI();
    await new Promise(r=>setTimeout(r,800));
  }
  document.getElementById('ticket-num').textContent = ticketId;
  document.getElementById('rep-page').style.display = 'none';
  document.getElementById('rep-success').classList.add('show');
  btn.textContent = 'ğŸš€ Enviar'; btn.disabled = false;
  uploadedPhotoUrl = null;
}

function selCat(btn, icon, label) {
  document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('sel'));
  btn.classList.add('sel');
  selCatData = { icon, label };
}

function selPrio(p) {
  selPrioData = p;
  document.querySelectorAll('.prio-btn').forEach(b=>b.className='prio-btn');
  if(p==='alta') document.getElementById('pb-h').classList.add('ph');
  else if(p==='media') document.getElementById('pb-m').classList.add('pm');
  else document.getElementById('pb-l').classList.add('pl');
}

function repStep(n) {
  [1,2,3].forEach(i=>{
    document.getElementById('rep-s'+i).classList.toggle('act', i===n);
    const s = document.getElementById('rs'+i);
    s.classList.toggle('act', i===n);
    s.classList.toggle('done', i<n);
    if(i<3) document.getElementById('rl'+i).classList.toggle('done', i<n);
  });
  if(n===3) updateSummary();
  document.querySelector('#sc-report .page').scrollTo(0,0);
}

function updateSummary() {
  document.getElementById('sum-cat').innerHTML = `<span style="font-size:17px">${selCatData.icon}</span> <strong>${selCatData.label}</strong>`;
  document.getElementById('sum-title').textContent = 'ğŸ“ ' + (document.getElementById('rep-title').value||'(sin tÃ­tulo)');
  const d = document.getElementById('rep-dist').value;
  const a = document.getElementById('rep-addr').value;
  document.getElementById('sum-loc').textContent = 'ğŸ“ ' + ([d,a].filter(Boolean).join(', ')||'(sin ubicaciÃ³n)');
}

function getLocation() {
  const btn = document.getElementById('loc-btn');
  btn.innerHTML='<span style="font-size:19px">â³</span><span>Obteniendo ubicaciÃ³n...</span>';
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos=>{
      userLat = pos.coords.latitude; userLng = pos.coords.longitude;
      btn.innerHTML=`<span style="font-size:19px">âœ…</span><span>${userLat.toFixed(4)}, ${userLng.toFixed(4)}</span>`;
      btn.classList.add('located');
    }, ()=>{ btn.innerHTML='<span style="font-size:19px">ğŸ“</span><span>No se pudo obtener ubicaciÃ³n</span>'; });
  }
}

let uploadedPhotoUrl = null;

function fakeUpload() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('up-icon').textContent='â³';
    document.getElementById('up-text').textContent='Subiendo foto...';
    if (dbOk && sb) {
      try {
        const fileName = `reporte_${Date.now()}_${file.name}`;
        const { data, error } = await sb.storage
          .from('fotos-reportes')
          .upload(fileName, file);
        if (error) throw error;
        const { data: urlData } = sb.storage.from('fotos-reportes').getPublicUrl(fileName);
        uploadedPhotoUrl = urlData.publicUrl;
        document.getElementById('up-icon').textContent='âœ…';
        document.getElementById('up-text').textContent=file.name + ' Â· cargada';
        showToast('ğŸ“· Foto subida exitosamente');
      } catch(e) {
        console.error('Error subiendo foto:', e);
        document.getElementById('up-icon').textContent='âŒ';
        document.getElementById('up-text').textContent='Error al subir foto';
        showToast('âŒ Error al subir foto', true);
      }
    } else {
      uploadedPhotoUrl = null;
      document.getElementById('up-icon').textContent='âœ…';
      document.getElementById('up-text').textContent=file.name + ' Â· cargada (demo)';
      showToast('ğŸ“· Foto adjuntada');
    }
  };
  input.click();
}

async function deleteReport(id) {
  if (!confirm('Â¿Seguro que querÃ©s eliminar este reporte?')) return;
  if (dbOk && sb) {
    try {
      const { error } = await sb.from('reportes').delete().eq('id', id);
      if (error) throw error;
      allReports = allReports.filter(r => r.id !== id);
      updateUI();
      closeSheetDirect();
      showToast('ğŸ—‘ï¸ Reporte eliminado');
    } catch(e) {
      console.error('Error al eliminar:', e);
      showToast('âŒ Error al eliminar', true);
    }
  } else {
    allReports = allReports.filter(r => r.id !== id);
    updateUI();
    closeSheetDirect();
    showToast('ğŸ—‘ï¸ Reporte eliminado');
  }
}

let newReportsCount = 0;

function incrementarBadge() {
  newReportsCount++;
  actualizarBadgeNav();
}

function actualizarBadgeNav() {
  document.querySelectorAll('.nav-badge-count').forEach(el => {
    if (newReportsCount > 0) {
      el.textContent = newReportsCount;
      el.style.display = 'flex';
    } else {
      el.style.display = 'none';
    }
  });
}

function limpiarBadge() {
  newReportsCount = 0;
  actualizarBadgeNav();
}

function pedirPermisoNotificaciones() {
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then(perm => {
      if (perm === 'granted') showToast('ğŸ”” Notificaciones activadas');
    });
  }
}

function notificarNuevoReporte(titulo, categoria, distrito) {
  if ('Notification' in window && Notification.permission === 'granted') {
    const icon = catIcon[categoria] || 'ğŸ“¢';
    new Notification('ğŸ›¡ï¸ Nuevo reporte en EscazÃº', {
      body: `${icon} ${titulo} Â· ${distrito}`,
      icon: 'https://api.dicebear.com/7.x/initials/svg?seed=ES&backgroundColor=00e5a0',
      badge: 'https://api.dicebear.com/7.x/initials/svg?seed=ES&backgroundColor=00e5a0',
      vibrate: [200, 100, 200],
      tag: 'nuevo-reporte'
    });
  }
}


let adminTaps = 0;
let adminTimer = null;
let isAdmin = false;

function adminTap() {
  adminTaps++;
  clearTimeout(adminTimer);
  adminTimer = setTimeout(() => { adminTaps = 0; }, 2000);
  if (adminTaps >= 5) {
    adminTaps = 0;
    const pass = prompt('ğŸ” ContraseÃ±a de administrador:');
    if (pass === 'Admin2026') {
      isAdmin = true;
      goTo('admin');
      renderAdminList();
      showToast('âœ… Bienvenido, Admin');
    } else if (pass !== null) {
      showToast('âŒ ContraseÃ±a incorrecta', true);
    }
  }
}

function cerrarAdmin() {
  isAdmin = false;
  goTo('home');
}

function renderAdminList() {
  const list = document.getElementById('admin-list');
  if (!list) return;
  setEl('adm-total', allReports.length);
  setEl('adm-activos', allReports.filter(r=>r.estado==='activo').length);
  setEl('adm-proceso', allReports.filter(r=>r.estado==='en_proceso').length);
  setEl('adm-resueltos', allReports.filter(r=>r.estado==='resuelto').length);
  if (!allReports.length) { list.innerHTML = '<div style="color:var(--text3);text-align:center;padding:20px;">Sin reportes</div>'; return; }
  list.innerHTML = allReports.map(r => `
    <div class="card" style="margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(r.titulo)}</div>
          <div style="font-size:11px;color:var(--text2);">${escHtml(r.distrito||'')} Â· ${timeAgo(r.created_at)}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:2px;">ğŸ“± ${escHtml(r.telefono||'â€”')} Â· ğŸªª ${escHtml(r.cedula||'â€”')}</div>
        </div>
        <span class="priority ${r.prioridad==='alta'?'p-high':r.prioridad==='media'?'p-med':'p-low'}" style="flex-shrink:0;margin-left:8px;">${(r.prioridad||'').toUpperCase()}</span>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button onclick="cambiarEstado(${r.id},'activo')" style="flex:1;padding:7px;border:1px solid ${r.estado==='activo'?'var(--accent)':'var(--border)'};background:${r.estado==='activo'?'rgba(0,229,160,.1)':'var(--bg3)'};color:${r.estado==='activo'?'var(--accent)':'var(--text2)'};border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;">ğŸ”´ Activo</button>
        <button onclick="cambiarEstado(${r.id},'en_proceso')" style="flex:1;padding:7px;border:1px solid ${r.estado==='en_proceso'?'var(--accent3)':'var(--border)'};background:${r.estado==='en_proceso'?'rgba(255,167,38,.1)':'var(--bg3)'};color:${r.estado==='en_proceso'?'var(--accent3)':'var(--text2)'};border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;">âš™ï¸ Proceso</button>
        <button onclick="cambiarEstado(${r.id},'resuelto')" style="flex:1;padding:7px;border:1px solid ${r.estado==='resuelto'?'var(--accent4)':'var(--border)'};background:${r.estado==='resuelto'?'rgba(68,138,255,.1)':'var(--bg3)'};color:${r.estado==='resuelto'?'var(--accent4)':'var(--text2)'};border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;">âœ… Resuelto</button>
        <button onclick="deleteReport(${r.id})" style="padding:7px 10px;border:1px solid rgba(255,82,82,.3);background:rgba(255,82,82,.08);color:var(--accent2);border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;">ğŸ—‘ï¸</button>
      </div>
    </div>`).join('');
}

async function cambiarEstado(id, estado) {
  const report = allReports.find(r=>r.id===id);
  if (!report) return;
  if (dbOk && sb) {
    try {
      await sb.from('reportes').update({ estado }).eq('id', id);
      showToast('âœ… Estado actualizado');
      await loadAllData();
      renderAdminList();
    } catch(e) { showToast('âŒ Error al actualizar', true); }
  } else {
    report.estado = estado;
    renderAdminList();
    updateUI();
  }
}

const screens = { home:'sc-home', alerts:'sc-alerts', map:'sc-map', report:'sc-report', stats:'sc-stats', admin:'sc-admin' };
let currentScreen = 'home';
function goTo(name) {
  document.getElementById(screens[currentScreen]).classList.remove('active');
  document.getElementById(screens[name]).classList.add('active');
  currentScreen = name;
  if(name==='report') {
    document.getElementById('rep-page').style.display='block';
    document.getElementById('rep-success').classList.remove('show');
    repStep(1);
  }
  if(name==='alerts') limpiarBadge();
  window.scrollTo(0,0);
}

function showToast(msg, isErr=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (isErr?' toast-err':'');
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2800);
}
function setEl(id, val) { const el=document.getElementById(id); if(el) el.textContent=val; }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(iso) {
  const diff = Date.now() - new Date(iso).getTime();
  const m = Math.floor(diff/60000);
  if(m<1) return 'ahora mismo';
  if(m<60) return `hace ${m} min`;
  const h = Math.floor(m/60);
  if(h<24) return `hace ${h}h`;
  const d = Math.floor(h/24);
  return `hace ${d} dÃ­a${d!==1?'s':''}`;
}

(function() {
  const d = new Date();
  setEl('home-date', `Zona EscazÃº Â· Activo Â· ${d.toLocaleDateString('es-CR',{weekday:'long',day:'numeric',month:'short'})}`);
  initSupabase();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('âœ… Service Worker registrado'))
      .catch(e => console.error('SW error:', e));
  }
  pedirPermisoNotificaciones();
})();
</script>
</body>
</html>
